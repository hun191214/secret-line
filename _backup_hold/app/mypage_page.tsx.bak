'use client';

import { useEffect, useState } from 'react';
import { useRouter } from 'next/navigation';
import CallOverlay from '../components/CallOverlay';

interface User {
  email: string;
  role: string;
  userId?: string;
  coins?: number;
}

interface CallData {
  callId: string;
  counselors: Array<{ id: string; name: string }>;
}

export default function MyPage() {
  const router = useRouter();
  const [user, setUser] = useState<User | null>(null);
  const [isLoading, setIsLoading] = useState(true);
  const [isLoggingOut, setIsLoggingOut] = useState(false);

  // í†µí™” ê´€ë ¨ ìƒíƒœ
  const [isCalling, setIsCalling] = useState(false);
  const [callData, setCallData] = useState<CallData | null>(null);
  const [isStartingCall, setIsStartingCall] = useState(false);

  useEffect(() => {
    // ì„¸ì…˜ ë° ì”ì•¡ í™•ì¸
    Promise.all([
      fetch('/api/auth/session').then((res) => res.json()),
      fetch('/api/charge/balance').then((res) => res.json()),
    ])
      .then(([sessionData, balanceData]) => {
        if (sessionData.authenticated && sessionData.user) {
          setUser({
            ...sessionData.user,
            coins: balanceData.coins || 0,
          });

          // ìƒë‹´ì‚¬ì¸ ê²½ìš° ìë™ ì˜¤í”„ë¼ì¸ ì „í™˜
          if (sessionData.user.role === 'COUNSELOR') {
            console.log('ğŸ“´ [ë§ˆì´í˜ì´ì§€] ìƒë‹´ì‚¬ ìë™ ì˜¤í”„ë¼ì¸ ì „í™˜');
            fetch('/api/counselor/status', {
              method: 'POST',
              headers: {
                'Content-Type': 'application/json',
              },
              body: JSON.stringify({ status: 'offline' }),
            }).catch((err) => {
              console.error('ì˜¤í”„ë¼ì¸ ì „í™˜ ì‹¤íŒ¨:', err);
            });
          }
        } else {
          router.push('/');
        }
        setIsLoading(false);
      })
      .catch(() => {
        setIsLoading(false);
        router.push('/');
      });
  }, [router]);

  const handleLogout = async () => {
    setIsLoggingOut(true);
    try {
      await fetch('/api/auth/logout', { method: 'POST' });
      router.push('/');
      router.refresh();
    } catch (error) {
      console.error('Logout failed:', error);
      setIsLoggingOut(false);
    }
  };

  // ìƒë‹´ ì‹œì‘í•˜ê¸° (ë©”ì¸ í˜ì´ì§€ì™€ ë™ì¼í•œ ë¡œì§)
  const handleStartCall = async () => {
    if (!user) {
      alert('ë¡œê·¸ì¸ì´ í•„ìš”í•©ë‹ˆë‹¤.');
      return;
    }

    // ìƒë‹´ì‚¬ëŠ” í†µí™” ì‹œì‘ ë¶ˆê°€
    if (user.role === 'COUNSELOR') {
      alert('ìƒë‹´ì‚¬ëŠ” í†µí™”ë¥¼ ì‹œì‘í•  ìˆ˜ ì—†ìŠµë‹ˆë‹¤. ëŒ€ì‹œë³´ë“œì—ì„œ í†µí™”ë¥¼ ê¸°ë‹¤ë ¤ì£¼ì„¸ìš”.');
      return;
    }

    setIsStartingCall(true);

    try {
      // DBì—ì„œ ì‹¤ì‹œê°„ ì½”ì¸ ì”ì•¡ ì¡°íšŒ
      const coinsResponse = await fetch('/api/user/coins', {
        method: 'GET',
        headers: {
          'Cache-Control': 'no-store',
          'Pragma': 'no-cache',
        },
        credentials: 'include',
      });

      if (coinsResponse.status === 401) {
        alert('ì¸ì¦ ì •ë³´ê°€ ë§Œë£Œë˜ì—ˆìŠµë‹ˆë‹¤. ë‹¤ì‹œ ë¡œê·¸ì¸í•´ì£¼ì„¸ìš”.');
        router.push('/login');
        return;
      }

      const coinsData = await coinsResponse.json();
      const userCoins = coinsData.success ? coinsData.coins : 0;

      // ìµœì†Œ ì½”ì¸ ì²´í¬ (14 ì½”ì¸ ì´ìƒ í•„ìš” - 1ë¶„ í†µí™”ë£Œ)
      if (userCoins < 14) {
        alert(`ì½”ì¸ ì”ì•¡ì´ ë¶€ì¡±í•©ë‹ˆë‹¤. (í˜„ì¬: ${userCoins} ì½”ì¸, í•„ìš”: 14 ì½”ì¸ ì´ìƒ)`);
        router.push('/charge');
        return;
      }

      // í†µí™” ë§¤ì¹­ ì‹œì‘
      const response = await fetch('/api/call/match', {
        method: 'POST',
      });

      const data = await response.json();

      if (data.success) {
        setCallData({
          callId: data.call.id,
          counselors: data.counselors,
        });
        setIsCalling(true);
      } else {
        alert(data.message || 'í†µí™” ì‹œì‘ì— ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤.');
      }
    } catch (error) {
      console.error('í†µí™” ì‹œì‘ ì˜¤ë¥˜:', error);
      alert('í†µí™” ì‹œì‘ ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.');
    } finally {
      setIsStartingCall(false);
    }
  };

  const handleCallCancel = () => {
    setIsCalling(false);
    setCallData(null);
    // í†µí™” ì¢…ë£Œ í›„ ì”ì•¡ ìƒˆë¡œê³ ì¹¨
    fetch('/api/charge/balance')
      .then((res) => res.json())
      .then((balanceData) => {
        if (user) {
          setUser({
            ...user,
            coins: balanceData.coins || 0,
          });
        }
      });
  };

  // ì—­í•  í•œê¸€ ë³€í™˜
  const getRoleDisplayName = (role: string) => {
    switch (role) {
      case 'MEMBER':
        return 'ì´ìš©ì (ë‚¨ì„±)';
      case 'COUNSELOR':
        return 'ìƒë‹´ì‚¬ (ì—¬ì„±)';
      case 'ADMIN':
        return 'ê´€ë¦¬ì';
      default:
        return role;
    }
  };

  // ì—­í•  ì´ëª¨ì§€
  const getRoleEmoji = (role: string) => {
    switch (role) {
      case 'MEMBER':
        return 'ğŸ‘¤';
      case 'COUNSELOR':
        return 'ğŸ‘©â€âš•ï¸';
      case 'ADMIN':
        return 'ğŸ‘‘';
      default:
        return 'ğŸ‘¤';
    }
  };

  if (isLoading) {
    return (
      <div className="min-h-screen bg-black flex items-center justify-center">
        <div className="text-center">
          <div className="inline-block w-8 h-8 border-4 border-[#D4AF37] border-t-transparent rounded-full animate-spin mb-4"></div>
          <p className="text-gray-400">ë¡œë”© ì¤‘...</p>
        </div>
      </div>
    );
  }

  if (!user) {
    return null; // ë¦¬ë‹¤ì´ë ‰íŠ¸ ì¤‘
  }

  return (
    <div className="min-h-screen bg-black">
      {/* í†µí™” ì˜¤ë²„ë ˆì´ */}
      {isCalling && callData && (
        <CallOverlay
          callId={callData.callId}
          counselors={callData.counselors}
          onCancel={handleCallCancel}
        />
      )}

      {/* í—¤ë” */}
      <header className="container mx-auto px-4 py-6 border-b border-[#D4AF37]/20">
        <div className="flex items-center justify-between">
          <a href="/" className="text-2xl font-bold" style={{ color: '#D4AF37' }}>
            Secret Line
          </a>
          <nav className="flex gap-4 items-center">
            <a
              href="/"
              className="text-white/80 hover:text-white transition-colors text-sm"
            >
              ë©”ì¸ìœ¼ë¡œ
            </a>
          </nav>
        </div>
      </header>

      {/* ë©”ì¸ ì½˜í…ì¸  */}
      <main className="container mx-auto px-4 py-12 max-w-2xl">
        <div className="text-center mb-8">
          <h1 className="text-4xl font-bold mb-2" style={{ color: '#D4AF37' }}>
            ë‚´ ì •ë³´
          </h1>
          <p className="text-gray-400">í”„ë¦¬ë¯¸ì—„ ë©¤ë²„ì‹­ ì¹´ë“œ</p>
        </div>

        {/* ë©¤ë²„ì‹­ ì¹´ë“œ */}
        <div
          className="bg-gradient-to-br from-gray-900 to-black rounded-3xl p-8 mb-8 shadow-2xl border-2"
          style={{ borderColor: '#D4AF37' }}
        >
          {/* ì¹´ë“œ ìƒë‹¨ ë””ìì¸ */}
          <div className="flex items-center justify-between mb-6">
            <div className="text-5xl">{getRoleEmoji(user.role)}</div>
            <div className="text-right">
              <div className="text-xs text-gray-500 uppercase tracking-wider mb-1">
                Secret Line
              </div>
              <div className="text-sm font-semibold" style={{ color: '#D4AF37' }}>
                Premium Member
              </div>
            </div>
          </div>

          {/* ì‚¬ìš©ì ì •ë³´ */}
          <div className="space-y-6">
            {/* ë‹‰ë„¤ì„/ì´ë©”ì¼ */}
            <div>
              <div className="text-xs text-gray-500 uppercase tracking-wider mb-2">
                ì´ë©”ì¼
              </div>
              <div className="text-xl font-semibold text-white">
                {user.email || 'ìµëª… ì‚¬ìš©ì'}
              </div>
            </div>

            {/* ì—­í•  */}
            <div>
              <div className="text-xs text-gray-500 uppercase tracking-wider mb-2">
                ë‚´ ì—­í• 
              </div>
              <div
                className="inline-block px-4 py-2 rounded-lg font-semibold text-lg"
                style={{
                  backgroundColor: '#D4AF37',
                  color: '#000000',
                }}
              >
                {getRoleEmoji(user.role)} {getRoleDisplayName(user.role)}
              </div>
            </div>

            {/* ì½”ì¸ ì”ì•¡ */}
            <div className="pt-4 border-t border-[#D4AF37]/30">
              <div className="flex items-center justify-between mb-4">
                <div>
                  {/* ì—­í• ì— ë”°ë¥¸ ëª…ì¹­ ë¶„ë¦¬ */}
                  <div className="text-xs text-gray-500 uppercase tracking-wider mb-2">
                    {user.role === 'COUNSELOR' ? 'ëˆ„ì  ì •ì‚°ê¸ˆ' : 'ì½”ì¸ ì”ì•¡'}
                  </div>
                  <div className="text-3xl font-bold text-white">
                    {user.coins?.toLocaleString() || 0}{' '}
                    <span className="text-xl" style={{ color: '#D4AF37' }}>
                      Coins
                    </span>
                  </div>
                  {/* USDT í™˜ì‚° ê°’ í‘œê¸° (100ì½”ì¸ = 1 USDT) - ëª¨ë“  ì—­í• ì— í‘œì‹œ */}
                  <div className="text-sm text-gray-400 mt-1">
                    (ì•½ {(((user.coins ?? 0) as number) / 100).toFixed(2)} USDT)
                  </div>
                </div>
                <div className="text-4xl">ğŸ’°</div>
              </div>

              {/* ì´ìš©ì ì „ìš©: ìƒë‹´ ì‹œì‘í•˜ê¸° ë²„íŠ¼ */}
              {user.role === 'MEMBER' && (
                <button
                  onClick={handleStartCall}
                  disabled={isStartingCall}
                  className="block w-full py-4 px-4 rounded-lg font-bold text-black text-lg text-center transition-all transform hover:scale-[1.02] mb-3 disabled:opacity-50 disabled:cursor-not-allowed disabled:transform-none"
                  style={{
                    background: 'linear-gradient(to right, #ec4899, #f43f5e)',
                    boxShadow: '0 0 20px rgba(236, 72, 153, 0.5)',
                  }}
                >
                  {isStartingCall ? (
                    <span className="flex items-center justify-center gap-2">
                      <span className="inline-block w-5 h-5 border-2 border-black border-t-transparent rounded-full animate-spin"></span>
                      ì—°ê²° ì¤‘...
                    </span>
                  ) : (
                    <>ğŸ“ ìƒë‹´ ì‹œì‘í•˜ê¸°</>
                  )}
                </button>
              )}

              {/* ì´ìš©ì ì „ìš©: ì¶©ì „í•˜ê¸° ë²„íŠ¼ */}
              {user.role === 'MEMBER' && (
                <a
                  href="/charge"
                  className="block w-full py-3 px-4 rounded-lg font-semibold text-black text-center transition-all transform hover:scale-[1.02] mb-3"
                  style={{ backgroundColor: '#D4AF37' }}
                >
                  ì¶©ì „í•˜ê¸°
                </a>
              )}

              {/* ìƒë‹´ì‚¬ ì „ìš©: ì¶œê¸ˆ ì‹ ì²­ (ì •ì‚°) ë²„íŠ¼ */}
              {user.role === 'COUNSELOR' && (
                <button
                  type="button"
                  className="block w-full py-3 px-4 rounded-lg font-semibold text-black text-center transition-all transform hover:scale-[1.02] mb-3"
                  style={{ backgroundColor: '#D4AF37' }}
                  onClick={() => alert('ì¶œê¸ˆ ì‹ ì²­ ê¸°ëŠ¥ì€ ì¤€ë¹„ ì¤‘ì…ë‹ˆë‹¤.')}
                >
                  ì¶œê¸ˆ ì‹ ì²­ (ì •ì‚°)
                </button>
              )}
              {/* ìƒë‹´ì‚¬ ì „ìš© ë²„íŠ¼ */}
              {user.role === 'COUNSELOR' && (
                <a
                  href="/counselor/dashboard"
                  className="block w-full py-4 px-4 rounded-lg font-bold text-black text-lg text-center transition-all transform hover:scale-[1.02]"
                  style={{
                    background: 'linear-gradient(to right, #ec4899, #f43f5e)',
                    boxShadow: '0 0 20px rgba(236, 72, 153, 0.5)',
                  }}
                >
                  ğŸ“ ì—…ë¬´ ì‹œì‘í•˜ê¸° (ëŒ€ì‹œë³´ë“œ)
                </a>
              )}
            </div>
          </div>
        </div>

        {/* ë¡œê·¸ì•„ì›ƒ ë²„íŠ¼ */}
        <div className="text-center">
          <button
            onClick={handleLogout}
            disabled={isLoggingOut}
            className="px-8 py-3 rounded-lg font-semibold text-black transition-all transform hover:scale-[1.02] disabled:opacity-50 disabled:cursor-not-allowed disabled:transform-none"
            style={{
              backgroundColor: isLoggingOut ? '#B8941F' : '#D4AF37',
            }}
          >
            {isLoggingOut ? (
              <span className="flex items-center justify-center gap-2">
                <span className="inline-block w-4 h-4 border-2 border-black border-t-transparent rounded-full animate-spin"></span>
                ë¡œê·¸ì•„ì›ƒ ì¤‘...
              </span>
            ) : (
              'ë¡œê·¸ì•„ì›ƒ'
            )}
          </button>
        </div>

        {/* í•˜ë‹¨ ì•ˆë‚´ */}
        <div className="mt-8 text-center">
          <p className="text-gray-500 text-xs">
            ê°œì¸ì •ë³´ëŠ” ì•”í˜¸í™”ë˜ì–´ ì•ˆì „í•˜ê²Œ ë³´ê´€ë©ë‹ˆë‹¤
          </p>
        </div>
      </main>
    </div>
  );
}
