import { NextResponse } from 'next/server';
import { cookies } from 'next/headers';
import { prisma, ensurePrismaConnected } from '@/lib/prisma';

/**
 * ì‚¬ìš©ì ì½”ì¸ ì”ì•¡ ì¡°íšŒ API (ì‹¤ì‹œê°„)
 * GET: í˜„ì¬ ë¡œê·¸ì¸í•œ ì‚¬ìš©ìì˜ ìµœì‹  ì½”ì¸ ì”ì•¡ ì¡°íšŒ
 * 
 * âš ï¸ ì£¼ì˜: Prisma 6.2.0 ë²„ì „ ìœ ì§€ í•„ìˆ˜
 */
export async function GET() {
  // ìºì‹œ ì œì–´ í—¤ë” (ëª¨ë“  ì‘ë‹µì— ì ìš©)
  const noCacheHeaders = {
    'Cache-Control': 'no-store, no-cache, must-revalidate, proxy-revalidate',
    'Pragma': 'no-cache',
    'Expires': '0',
  };

  try {
    // 1. ì„¸ì…˜ ì¿ í‚¤ í™•ì¸ (await cookies() ì‚¬ìš©)
    const cookieStore = await cookies();
    const sessionCookie = cookieStore.get('auth_session');

    if (!sessionCookie) {
      console.error('[ì‹¤ì „ ë¡œê·¸] ì‚¬ìš©ì ì´ë©”ì¼: ë¯¸í™•ì¸ | ì½”ì¸ ì¡°íšŒ ì‹œë„ ì¤‘ ì¸ì¦ ì‹¤íŒ¨ - ì„¸ì…˜ ì¿ í‚¤ ì—†ìŒ');
      return NextResponse.json(
        { success: false, message: 'ë¡œê·¸ì¸ì´ í•„ìš”í•©ë‹ˆë‹¤.' },
        { status: 401, headers: noCacheHeaders }
      );
    }

    // 2. ì„¸ì…˜ íŒŒì‹±
    let session;
    try {
      session = JSON.parse(sessionCookie.value);
    } catch {
      console.error('[ì‹¤ì „ ë¡œê·¸] ì‚¬ìš©ì ì´ë©”ì¼: íŒŒì‹± ë¶ˆê°€ | ì½”ì¸ ì¡°íšŒ ì‹œë„ ì¤‘ ì¸ì¦ ì‹¤íŒ¨ - ì„¸ì…˜ ì¿ í‚¤ íŒŒì‹± ì‹¤íŒ¨');
      return NextResponse.json(
        { success: false, message: 'ì„¸ì…˜ ì •ë³´ë¥¼ í™•ì¸í•  ìˆ˜ ì—†ìŠµë‹ˆë‹¤.' },
        { status: 401, headers: noCacheHeaders }
      );
    }

    // 3. ì´ë©”ì¼ í™•ì¸
    const userEmail = session.email;
    if (!userEmail) {
      console.error('[ì‹¤ì „ ë¡œê·¸] ì‚¬ìš©ì ì´ë©”ì¼: N/A | ì½”ì¸ ì¡°íšŒ ì‹œë„ ì¤‘ ì¸ì¦ ì‹¤íŒ¨ - ì„¸ì…˜ì— ì´ë©”ì¼ ì •ë³´ ì—†ìŒ');
      return NextResponse.json(
        { success: false, message: 'ì„¸ì…˜ ì •ë³´ê°€ ì˜¬ë°”ë¥´ì§€ ì•ŠìŠµë‹ˆë‹¤.' },
        { status: 401, headers: noCacheHeaders }
      );
    }

    console.log(`ğŸ”” [ì½”ì¸ ì¡°íšŒ] ì‚¬ìš©ì ìš”ì²­: ${userEmail}`);

    // 4. DB ì—°ê²° í™•ì¸ (ë‹¨ í•œ ë²ˆë§Œ í˜¸ì¶œ)
    const dbConnected = await ensurePrismaConnected();
    if (!dbConnected) {
      console.error(`[ì‹¤ì „ ë¡œê·¸] ì‚¬ìš©ì ì´ë©”ì¼: ${userEmail} | ì½”ì¸ ì¡°íšŒ ì‹œë„ ì¤‘ ì„œë²„ ì˜¤ë¥˜ - DB ì—°ê²° ì‹¤íŒ¨`);
      return NextResponse.json(
        { success: false, message: 'ë°ì´í„°ë² ì´ìŠ¤ ì—°ê²°ì— ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤.' },
        { status: 503, headers: noCacheHeaders }
      );
    }

    // 5. DBì—ì„œ ìµœì‹  ì½”ì¸ ì”ì•¡ ì¡°íšŒ
    let user;
    try {
      user = await prisma.user.findUnique({
        where: { email: userEmail },
        select: { coins: true, email: true },
      });
    } catch (dbError: any) {
      console.error(`[ì‹¤ì „ ë¡œê·¸] ì‚¬ìš©ì ì´ë©”ì¼: ${userEmail} | ì½”ì¸ ì¡°íšŒ ì‹œë„ ì¤‘ ì„œë²„ ì˜¤ë¥˜ - DB ì¡°íšŒ ì‹¤íŒ¨`);
      console.error(`   â†’ ì˜¤ë¥˜ ìƒì„¸: ${dbError?.message}`);
      return NextResponse.json(
        { success: false, message: 'ì½”ì¸ ì”ì•¡ ì¡°íšŒ ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.' },
        { status: 500, headers: noCacheHeaders }
      );
    }

    // 6. ì‚¬ìš©ì ì¡´ì¬ ì—¬ë¶€ í™•ì¸
    if (!user) {
      console.error(`[ì‹¤ì „ ë¡œê·¸] ì‚¬ìš©ì ì´ë©”ì¼: ${userEmail} | ì½”ì¸ ì¡°íšŒ ì‹œë„ ì¤‘ ì¸ì¦ ì‹¤íŒ¨ - DBì—ì„œ ì‚¬ìš©ìë¥¼ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤.`);
      console.error(`   â†’ ì‹œë„ ì‹œê°„: ${new Date().toISOString()}`);
      return NextResponse.json(
        { success: false, message: 'ì‚¬ìš©ìë¥¼ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤.' },
        { status: 404, headers: noCacheHeaders }
      );
    }

    // 7. ì½”ì¸ ê°’ ì²˜ë¦¬ (nullì´ë©´ 0ìœ¼ë¡œ)
    const userCoins = user.coins ?? 0;
    console.log(`âœ… [ì½”ì¸ ì¡°íšŒ] ì„±ê³µ: ì‚¬ìš©ì [${userEmail}]ì˜ í˜„ì¬ ì½”ì¸ ì”ì•¡ = ${userCoins} ì½”ì¸`);

    // 8. ì„¸ì…˜ ì¿ í‚¤ ì—…ë°ì´íŠ¸ (ë™ê¸°í™”)
    cookieStore.set('auth_session', JSON.stringify({
      ...session,
      coins: userCoins,
    }), {
      httpOnly: true,
      secure: process.env.NODE_ENV === 'production',
      sameSite: 'lax',
      maxAge: 60 * 60 * 24 * 7,
      path: '/',
    });

    // 9. ì„±ê³µ ì‘ë‹µ
    return NextResponse.json({
      success: true,
      coins: userCoins,
      email: user.email,
    }, { headers: noCacheHeaders });

  } catch (error: any) {
    console.error('[ì‹¤ì „ ë¡œê·¸] ì‚¬ìš©ì ì´ë©”ì¼: ë¯¸í™•ì¸ | ì½”ì¸ ì¡°íšŒ ì‹œë„ ì¤‘ ì˜ˆìƒì¹˜ ëª»í•œ ì„œë²„ ì˜¤ë¥˜');
    console.error(`   â†’ ì˜¤ë¥˜ ë©”ì‹œì§€: ${error?.message}`);
    return NextResponse.json(
      { success: false, message: 'ì„œë²„ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.' },
      { status: 500, headers: noCacheHeaders }
    );
  }
}
