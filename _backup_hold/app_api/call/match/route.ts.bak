import { NextRequest, NextResponse } from 'next/server';
import { cookies } from 'next/headers';
import { prisma, ensurePrismaConnected } from '@/lib/prisma';

/**
 * í†µí™” ë§¤ì¹­ API
 * POST: í†µí™” ì‹œì‘ ë° ìƒë‹´ì‚¬ ë§¤ì¹­ ì‹œì‘
 * GET: í˜„ì¬ ë§¤ì¹­ ìƒíƒœ ì¡°íšŒ
 */

// ì„¸ì…˜ì—ì„œ ì‚¬ìš©ì ì •ë³´ ê°€ì ¸ì˜¤ê¸°
async function getSessionUser() {
  const cookieStore = await cookies();
  const sessionCookie = cookieStore.get('auth_session');
  
  if (!sessionCookie) {
    return null;
  }
  
  try {
    const session = JSON.parse(sessionCookie.value);
    return session;
  } catch {
    return null;
  }
}

// ì˜¨ë¼ì¸ ìƒíƒœì¸ ìƒë‹´ì‚¬ ëª©ë¡ ì¡°íšŒ
async function getOnlineCounselors() {
  try {
    await prisma.$connect();
  } catch {
    // ì—°ê²° ì‹¤íŒ¨í•´ë„ ê³„ì† ì§„í–‰
  }

  const isConnected = await ensurePrismaConnected();
  
  if (!isConnected) {
    console.log('âš ï¸ [ë§¤ì¹­] DB ì—°ê²° ì‹¤íŒ¨ - Mock ë°ì´í„° ë°˜í™˜');
    // Mock ë°ì´í„° ë°˜í™˜ (ì˜¨ë¼ì¸ ìƒíƒœì¸ ìƒë‹´ì‚¬)
    return [
      { id: 'mock-1', name: 'ì§€ì•„', email: 'counselor1@example.com' },
      { id: 'mock-2', name: 'ì„œì—°', email: 'counselor2@example.com' },
    ];
  }

  try {
    // DBì—ì„œ ONLINE ìƒíƒœì¸ ìƒë‹´ì‚¬ë§Œ ì¡°íšŒ (ì—„ê²©í•œ í•„í„°ë§)
    const onlineCounselors = await prisma.user.findMany({
      where: {
        role: 'COUNSELOR',
        status: 'ONLINE', // ONLINE ìƒíƒœì¸ ìƒë‹´ì‚¬ë§Œ ì¡°íšŒ
      },
      select: {
        id: true,
        email: true,
        name: true,
        updatedAt: true, // ë§ˆì§€ë§‰ ì—…ë°ì´íŠ¸ ì‹œê°„ í™•ì¸ìš©
      },
      orderBy: {
        updatedAt: 'desc', // ìµœê·¼ ì—…ë°ì´íŠ¸ëœ ìˆœìœ¼ë¡œ ì •ë ¬
      },
    });

    console.log(`ğŸ”” [ë§¤ì¹­] ONLINE ìƒíƒœì¸ ìƒë‹´ì‚¬ ìˆ˜: ${onlineCounselors.length}`);
    onlineCounselors.forEach((c) => {
      console.log(`  - ${c.email} (${c.name || 'ì´ë¦„ ì—†ìŒ'}) - Status: ONLINE`);
    });

    // ONLINE ìƒíƒœì¸ ìƒë‹´ì‚¬ê°€ ì—†ìœ¼ë©´ ë¹ˆ ë°°ì—´ ë°˜í™˜
    if (onlineCounselors.length === 0) {
      console.log('âš ï¸ [ë§¤ì¹­] ONLINE ìƒíƒœì¸ ìƒë‹´ì‚¬ê°€ 0ëª…ì…ë‹ˆë‹¤.');
      return [];
    }

    // 200@gmail.com ìƒë‹´ì‚¬ê°€ ìˆìœ¼ë©´ ë§¨ ì•ìœ¼ë¡œ ì´ë™
    const formattedCounselors = onlineCounselors.map((c) => ({
      id: c.id,
      name: c.name || c.email?.split('@')[0] || 'ìƒë‹´ì‚¬',
      email: c.email || '',
    }));

    const targetCounselor = formattedCounselors.find((c) => c.email === '200@gmail.com');
    if (targetCounselor && formattedCounselors.length > 1) {
      const filtered = formattedCounselors.filter((c) => c.email !== '200@gmail.com');
      formattedCounselors.length = 0;
      formattedCounselors.push(targetCounselor, ...filtered);
      console.log(`ğŸ”” [ë§¤ì¹­] 200@gmail.com ìƒë‹´ì‚¬ë¥¼ ëª©ë¡ ë§¨ ì•ìœ¼ë¡œ ì´ë™`);
    }

    console.log(`âœ… [ë§¤ì¹­] ìµœì¢… ONLINE ìƒë‹´ì‚¬ ìˆ˜: ${formattedCounselors.length}`);
    return formattedCounselors;
  } catch (error: any) {
    console.error('âŒ [ë§¤ì¹­] ìƒë‹´ì‚¬ ì¡°íšŒ ì˜¤ë¥˜:', error?.message);
    // ì—ëŸ¬ ë°œìƒ ì‹œ ë¹ˆ ë°°ì—´ ë°˜í™˜ (Mock ë°ì´í„° ì œê±°)
    return [];
  }
}

// í†µí™” ì‹œì‘ (POST)
export async function POST(request: NextRequest) {
  try {
    const session = await getSessionUser();
    
    if (!session || !session.userId) {
      return NextResponse.json(
        { success: false, message: 'ë¡œê·¸ì¸ì´ í•„ìš”í•©ë‹ˆë‹¤.' },
        { status: 401 }
      );
    }

    // ì´ìš©ì(MEMBER)ë§Œ í†µí™” ê°€ëŠ¥
    if (session.role !== 'MEMBER') {
      return NextResponse.json(
        { success: false, message: 'ì´ìš©ìë§Œ í†µí™”ë¥¼ ì‹œì‘í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤.' },
        { status: 403 }
      );
    }

    // ì˜¨ë¼ì¸ ìƒë‹´ì‚¬ ëª©ë¡ ì¡°íšŒ
    const onlineCounselors = await getOnlineCounselors();

    if (onlineCounselors.length === 0) {
      console.log('âš ï¸ [ë§¤ì¹­] ì˜¨ë¼ì¸ ìƒë‹´ì‚¬ 0ëª… - í†µí™” ì°¨ë‹¨');
      return NextResponse.json(
        { success: false, message: 'ìƒë‹´ì‚¬ê°€ í˜„ì¬ ì˜¤í”„ë¼ì¸ ìƒíƒœì…ë‹ˆë‹¤. ì ì‹œ í›„ ë‹¤ì‹œ ì‹œë„í•´ì£¼ì„¸ìš”.' },
        { status: 404 }
      );
    }

    // í†µí™” ê¸°ë¡ ìƒì„± (ì²« ë²ˆì§¸ ìƒë‹´ì‚¬ì—ê²Œ ë¨¼ì € í˜¸ì¶œ)
    const firstCounselor = onlineCounselors[0];

    try {
      await prisma.$connect();
    } catch {
      // ì—°ê²° ì‹¤íŒ¨í•´ë„ ê³„ì† ì§„í–‰
    }

    const isConnected = await ensurePrismaConnected();
    
    let callRecord;
    if (isConnected) {
      try {
        callRecord = await prisma.call.create({
          data: {
            callerId: session.userId,
            counselorId: firstCounselor.id,
            status: 'CONNECTING',
            startedAt: new Date(),
          },
          select: {
            id: true,
            status: true,
            startedAt: true,
          },
        });
      } catch (dbError: any) {
        console.error('í†µí™” ê¸°ë¡ ìƒì„± ì˜¤ë¥˜:', dbError?.message);
        // DB ì €ì¥ ì‹¤íŒ¨í•´ë„ ê³„ì† ì§„í–‰ (Mock ëª¨ë“œ)
        callRecord = {
          id: `call_${Date.now()}`,
          status: 'CONNECTING',
          startedAt: new Date(),
        };
      }
    } else {
      // Mock ëª¨ë“œ
      callRecord = {
        id: `call_${Date.now()}`,
        status: 'CONNECTING',
        startedAt: new Date(),
      };
    }

    return NextResponse.json({
      success: true,
      message: 'í†µí™” ë§¤ì¹­ì´ ì‹œì‘ë˜ì—ˆìŠµë‹ˆë‹¤.',
      call: {
        id: callRecord.id,
        status: callRecord.status,
        startedAt: callRecord.startedAt,
      },
      counselors: onlineCounselors.map((c: any) => ({
        id: c.id,
        name: c.name || c.email,
      })),
      currentCounselorIndex: 0,
    });
  } catch (error: any) {
    console.error('í†µí™” ë§¤ì¹­ ì˜¤ë¥˜:', error?.message);
    return NextResponse.json(
      { success: false, message: 'í†µí™” ë§¤ì¹­ ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.' },
      { status: 500 }
    );
  }
}

// í†µí™” ìƒíƒœ ì¡°íšŒ (GET)
export async function GET(request: NextRequest) {
  try {
    const session = await getSessionUser();
    
    if (!session || !session.userId) {
      return NextResponse.json(
        { success: false, message: 'ë¡œê·¸ì¸ì´ í•„ìš”í•©ë‹ˆë‹¤.' },
        { status: 401 }
      );
    }

    const { searchParams } = new URL(request.url);
    const callId = searchParams.get('callId');
    const counselorIndex = parseInt(searchParams.get('counselorIndex') || '0');

    if (!callId) {
      return NextResponse.json(
        { success: false, message: 'í†µí™” IDê°€ í•„ìš”í•©ë‹ˆë‹¤.' },
        { status: 400 }
      );
    }

    // ì˜¨ë¼ì¸ ìƒë‹´ì‚¬ ëª©ë¡ ì¡°íšŒ
    const onlineCounselors = await getOnlineCounselors();

    if (onlineCounselors.length === 0) {
      console.log('âš ï¸ [ë§¤ì¹­ GET] ì˜¨ë¼ì¸ ìƒë‹´ì‚¬ 0ëª…');
      return NextResponse.json(
        { success: false, message: 'ìƒë‹´ì‚¬ê°€ í˜„ì¬ ì˜¤í”„ë¼ì¸ ìƒíƒœì…ë‹ˆë‹¤.' },
        { status: 404 }
      );
    }

    // ë‹¤ìŒ ìƒë‹´ì‚¬ ì¸ë±ìŠ¤ ê³„ì‚° (ë¬´í•œ ë£¨í”„)
    const nextIndex = (counselorIndex + 1) % onlineCounselors.length;
    const nextCounselor = onlineCounselors[nextIndex];

    // í†µí™” ê¸°ë¡ ì—…ë°ì´íŠ¸ (ë‹¤ìŒ ìƒë‹´ì‚¬ë¡œ ë³€ê²½)
    const isConnected = await ensurePrismaConnected();
    
    if (isConnected) {
      try {
        await prisma.call.update({
          where: { id: callId },
          data: {
            counselorId: nextCounselor.id,
            status: 'CONNECTING',
            updatedAt: new Date(),
          },
        });
      } catch (dbError: any) {
        console.error('í†µí™” ê¸°ë¡ ì—…ë°ì´íŠ¸ ì˜¤ë¥˜:', dbError?.message);
        // ì—…ë°ì´íŠ¸ ì‹¤íŒ¨í•´ë„ ê³„ì† ì§„í–‰
      }
    }

    return NextResponse.json({
      success: true,
      call: {
        id: callId,
        status: 'CONNECTING',
      },
      currentCounselor: {
        id: nextCounselor.id,
        name: nextCounselor.name || nextCounselor.email,
      },
      currentCounselorIndex: nextIndex,
      totalCounselors: onlineCounselors.length,
    });
  } catch (error: any) {
    console.error('í†µí™” ìƒíƒœ ì¡°íšŒ ì˜¤ë¥˜:', error?.message);
    return NextResponse.json(
      { success: false, message: 'í†µí™” ìƒíƒœ ì¡°íšŒ ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.' },
      { status: 500 }
    );
  }
}

