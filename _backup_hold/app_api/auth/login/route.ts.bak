import { NextRequest, NextResponse } from 'next/server';
import { cookies } from 'next/headers';
import { prisma, ensurePrismaConnected } from '@/lib/prisma';

/**
 * 로그인 API: 실제 DB 조회 우선, 실패 시 Mock 저장소 사용
 */
export async function POST(request: NextRequest) {
  try {
    const body = await request.json();
    const { email, password } = body;

    // 입력 형식 검증
    if (!email || !password) {
      return NextResponse.json(
        { success: false, message: '이메일과 비밀번호를 입력해주세요.' },
        { status: 400 }
      );
    }

    // 이메일 형식 검증 (간단한 검증)
    const emailRegex = /^[^\s@]+@[^\s@]+\.[^\s@]+$/;
    if (!emailRegex.test(email)) {
      return NextResponse.json(
        { success: false, message: '올바른 이메일 형식이 아닙니다.' },
        { status: 400 }
      );
    }

    // 비밀번호 최소 길이 검증 (4자 이상)
    if (password.length < 4) {
      return NextResponse.json(
        { success: false, message: '비밀번호는 최소 4자 이상이어야 합니다.' },
        { status: 400 }
      );
    }

    const cookieStore = await cookies();
    const mockUserEmail = email;

    // 실제 DB 연결 확인
    const isConnected = await ensurePrismaConnected();
    
    if (!isConnected) {
      return NextResponse.json(
        { success: false, message: '데이터베이스 연결에 실패했습니다. 서버 관리자에게 문의하세요.' },
        { status: 503 }
      );
    }

    // DB에서 사용자 조회
    let user;
    try {
      user = await prisma.user.findUnique({
        where: { email: mockUserEmail },
        select: {
          id: true,
          email: true,
          role: true,
          password: true,
          coins: true, // 코인 잔액도 함께 조회
        },
      });
    } catch (dbError: any) {
      return NextResponse.json(
        { success: false, message: '로그인 처리 중 오류가 발생했습니다.' },
        { status: 500 }
      );
    }

    if (!user) {
      return NextResponse.json(
        { success: false, message: '등록되지 않은 이메일입니다.' },
        { status: 401 }
      );
    }

    // 비밀번호 검증 (실제 운영에서는 해시 비교 필요)
    // 현재는 Mock이므로 형식만 검증
    if (password.length < 4) {
      return NextResponse.json(
        { success: false, message: '비밀번호가 올바르지 않습니다.' },
        { status: 401 }
      );
    }

    // 세션 쿠키 설정 (coins 필드 포함)
    cookieStore.set('auth_session', JSON.stringify({
      userId: user.id,
      email: mockUserEmail,
      role: user.role,
      coins: user.coins || 0, // DB의 코인 잔액 포함
      loginTime: Date.now(),
    }), {
      httpOnly: true,
      secure: process.env.NODE_ENV === 'production',
      sameSite: 'lax',
      maxAge: 60 * 60 * 24 * 7, // 7일
      path: '/',
    });

    return NextResponse.json({
      success: true,
      message: '로그인 성공',
      user: {
        email: mockUserEmail,
        role: user.role,
      },
    });
  } catch (error) {
    return NextResponse.json(
      { success: false, message: '서버 오류가 발생했습니다.' },
      { status: 500 }
    );
  }
}

