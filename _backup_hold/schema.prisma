// This is your Prisma schema file,
// learn more about it in the docs: https://pris.ly/d/prisma-schema

generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "sqlite"
  url      = "file:./dev.db"
}

// 사용자 모델
model User {
  id          String   @id @default(cuid())
  email       String?  @unique
  phone       String?  @unique
  password    String?  // 비밀번호 (해시된 값 저장)
  name        String?
  role        UserRole @default(MEMBER)
  gender      Gender?
  coins       Int      @default(0) // 코인 잔액
  status      CounselorStatus? // 상담사 온라인 상태 (ONLINE/OFFLINE)
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt

  // 관계
  payments        Payment[]
  callsAsCaller   Call[]     @relation("CallerCalls")
  callsAsCounselor Call[]    @relation("CounselorCalls")
  referrals       Referral[] @relation("ReferrerUser")
  referredBy      Referral?  @relation("ReferredUser")
  settlements     Settlement[]

  @@map("users")
}

enum UserRole {
  MEMBER      // 일반 회원
  COUNSELOR   // 상담사
  ADMIN       // 관리자
}

enum Gender {
  MALE
  FEMALE
  OTHER
}

enum CounselorStatus {
  ONLINE
  OFFLINE
}

// 결제 모델
model Payment {
  id              String        @id @default(cuid())
  userId          String
  amount          Float         // 결제 금액 (USD)
  currency        String        @default("USD")
  paymentId       String        @unique // NOWPayments 결제 ID
  status          PaymentStatus @default(PENDING)
  paymentMethod   String?       // 결제 수단
  metadata        Json?         // 추가 메타데이터
  createdAt       DateTime      @default(now())
  updatedAt       DateTime      @updatedAt

  // 관계
  user            User          @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@map("payments")
}

enum PaymentStatus {
  PENDING
  PROCESSING
  COMPLETED
  FAILED
  REFUNDED
}

// 통화 모델
model Call {
  id              String   @id @default(cuid())
  callerId        String   // 통화 요청자 (남성 회원)
  counselorId     String   // 상담사
  status          CallStatus @default(INITIATED)
  startedAt       DateTime?
  endedAt         DateTime?
  duration        Int?     @default(0) // 통화 시간 (초)
  cost            Float?   // 통화 비용 (USD)
  agoraChannel    String?  // Agora 채널명
  agoraToken      String?  // Agora 토큰
  referralId      String?  // 추천인 ID (있을 경우)
  createdAt       DateTime @default(now())
  updatedAt       DateTime @updatedAt

  // 관계
  caller          User     @relation("CallerCalls", fields: [callerId], references: [id], onDelete: Cascade)
  counselor       User     @relation("CounselorCalls", fields: [counselorId], references: [id], onDelete: Cascade)
  referral        Referral? @relation(fields: [referralId], references: [id])
  settlements     Settlement[]

  @@map("calls")
}

enum CallStatus {
  INITIATED   // 시작됨
  CONNECTING  // 연결 중
  ACTIVE      // 진행 중
  ENDED       // 종료됨
  CANCELLED   // 취소됨
}

// 추천인 모델
model Referral {
  id              String   @id @default(cuid())
  referrerId      String   // 추천인 (남성 회원)
  referredId      String   // 피추천인 (신규 회원)
  referralCode    String   @unique // 추천인 코드
  status          ReferralStatus @default(ACTIVE)
  totalEarnings   Float    @default(0) // 총 수익
  createdAt       DateTime @default(now())
  updatedAt       DateTime @updatedAt

  // 관계
  referrer        User     @relation("ReferrerUser", fields: [referrerId], references: [id], onDelete: Cascade)
  referred        User     @relation("ReferredUser", fields: [referredId], references: [id], onDelete: Cascade)
  
  @@unique([referredId])
  calls           Call[]

  @@map("referrals")
}

enum ReferralStatus {
  ACTIVE
  INACTIVE
}

// 정산 모델
model Settlement {
  id              String   @id @default(cuid())
  userId          String   // 정산 대상자
  callId          String?  // 관련 통화 ID
  amount          Float    // 정산 금액
  type            SettlementType
  percentage      Float    // 배분 비율 (0.6, 0.1, 0.3, 0.4 등)
  status          SettlementStatus @default(PENDING)
  settledAt       DateTime?
  createdAt       DateTime @default(now())
  updatedAt       DateTime @updatedAt

  // 관계
  user            User     @relation(fields: [userId], references: [id], onDelete: Cascade)
  call            Call?    @relation(fields: [callId], references: [id], onDelete: SetNull)

  @@map("settlements")
}

enum SettlementType {
  COUNSELOR    // 상담사 정산 (60%)
  REFERRER     // 추천인 정산 (10%)
  COMPANY      // 회사 정산 (30% 또는 40%)
}

enum SettlementStatus {
  PENDING      // 대기 중
  PROCESSING   // 처리 중
  COMPLETED    // 완료
  FAILED       // 실패
}

